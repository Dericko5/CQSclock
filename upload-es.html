<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CQS | Env√≠o de Fotos</title>

  <style>
    .lang-toggle{
    position:fixed; top:12px; right:12px; z-index:50;
    }
    .lang-toggle a{
    font-size:12px; padding:6px 10px; border-radius:999px;
    color:#cfd3d7; text-decoration:none;
    border:1px solid rgba(255,255,255,.2);
    background:rgba(255,255,255,.08);
    backdrop-filter:blur(6px);
    transition:transform .15s;
    }
    .lang-toggle a:hover{ transform:translateY(-1px); }
    /* ===============================
       Base / Layout
       =============================== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #fff;
      background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
    }

    .container {
      width: 100%;
      max-width: 440px;
      margin: auto;
      padding: 24px;
    }

    /* ===============================
       Header
       =============================== */
    .logo {
      text-align: center;
      font-size: 28px;
      font-weight: 800;
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0,255,136,.3);
      margin-bottom: 6px;
    }

    .subtitle {
      text-align: center;
      color: #9aa0a6;
      margin-bottom: 24px;
      font-size: 14px;
    }

    /* ===============================
       Card / Sections
       =============================== */
    .card {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
    }

    /* ===============================
       Form controls
       =============================== */
    label {
      display: block;
      color: #cfd3d7;
      font-size: 14px;
      margin: 10px 0 8px;
    }

    input,
    select {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.1);
      color: #fff;
      margin-bottom: 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    input:focus,
    select:focus {
      border-color: #00ff88;
      box-shadow: 0 0 8px rgba(0,255,136,.2);
    }

    /* Select: dark dropdown + custom arrow */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #bbb 50%),
        linear-gradient(135deg, #bbb 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 20px) calc(50% - 4px),
        calc(100% - 14px) calc(50% - 4px),
        calc(100% - 2.2em) 0.6em;
      background-size: 6px 6px, 6px 6px, 1px 1.4em;
      background-repeat: no-repeat;
      padding-right: 2.6em;
    }
    select option {
      background-color: #0f0f0f;
      color: #fff;
    }

    /* ===============================
       Camera / Preview
       =============================== */
    .camera {
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .preview {
      height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }
    .preview img,
    .preview video {
      width: 100%;
      height: 260px;
      object-fit: cover;
      display: block;
    }
    .camera-actions {
      padding: 12px;
      text-align: center;
      display: grid;
      gap: 8px;
    }

    /* ===============================
       Buttons
       =============================== */
    .btn {
      width: 100%;
      padding: 16px;
      border: 0;
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: .5px;
      cursor: pointer;
      transition: transform .15s, box-shadow .15s, opacity .15s;
    }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
      box-shadow: 0 6px 24px rgba(0,255,136,.3);
    }
    .btn-primary:not(:disabled):hover { transform: translateY(-1px); }

    .btn-sec {
      background: linear-gradient(135deg, #4a9eff, #0066cc);
      color: #fff;
    }
    .btn-sec:hover { transform: translateY(-1px); }

    /* ===============================
       Messages
       =============================== */
    .msg {
      display: none;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 10px;
      font-weight: 600;
      text-align: center;
    }
    .msg.ok  { display: block; background: linear-gradient(135deg,#00ff88,#00cc6a); color:#000; }
    .msg.err { display: block; background: linear-gradient(135deg,#ff6b6b,#ee5a52); color:#fff; }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">CQS Upload</div>
    <div class="subtitle">Env√≠a hasta 50 fotos por d√≠a por ubicaci√≥n</div>

    <div id="message" class="msg"></div>

    <div class="card">
      <label for="code">C√≥digo de acceso</label>
      <input id="code" type="password" placeholder="Ingresa el c√≥digo" autocomplete="one-time-code" required />

      <label for="location">Ubicaci√≥n</label>
      <select id="location" required>
        <option value="">Selecciona una ubicaci√≥n‚Ä¶</option>
      </select>

      <label for="jobsite">Nombre del sitio de trabajo</label>
      <input id="jobsite" type="text" placeholder="p. ej., ACME" required />

      <div class="camera" style="margin-top:8px">
        <div id="preview" class="preview">üì∑ Elige o toma una foto</div>
        <div class="camera-actions">
          <!-- elegir desde archivos -->
          <input id="file" type="file" accept="image/*" multiple hidden />
          <!-- c√°mara nativa en m√≥vil -->
          <input id="cameraFile" type="file" accept="image/*" capture="environment" hidden />
          <button id="chooseBtn"  class="btn btn-sec" type="button">üìÅ Elegir foto</button>
          <button id="captureBtn" class="btn btn-sec" type="button">üì∏ Usar c√°mara</button>
        </div>
      </div>

      <button id="submitBtn" class="btn btn-primary" style="margin-top:12px" disabled>Enviar</button>
    </div>

    <style>
      .nav-links{margin-top:10px;text-align:center}
      .btn-link{
        display:inline-block;padding:12px 16px;border-radius:10px;
        border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);
        color:#cfd3d7;text-decoration:none;font-weight:700;letter-spacing:.3px
      }
      .btn-link:hover{border-color:#00ff88;box-shadow:0 0 8px rgba(0,255,136,.2);color:#fff}
    </style>
    <div class="nav-links">
      <a class="btn-link" href="/index.html">‚Üê Volver al inicio</a>
    </div>

<script>
  // ---------- State ----------
  let selectedFiles = [];
  let capturedBlob = null;
  let stream = null, video = null, msgHideTimer = null;
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const code        = $('code');
  const locationSel = $('location');
  const jobsite     = $('jobsite');
  const submitBtn   = $('submitBtn');

  function showMsg(text, ok = true) {
    const m = $('message');
    m.style.display = 'block';
    m.className = 'msg ' + (ok ? 'ok' : 'err');
    m.textContent = text;
    clearTimeout(msgHideTimer);
    msgHideTimer = setTimeout(() => m.style.display = 'none', 5000);
  }

  function enableSubmit(){
    submitBtn.disabled = !(
      code.value.trim() &&
      locationSel.value &&
      jobsite.value.trim() &&
      (selectedFiles.length > 0 || capturedBlob)
    );
  }

  function stopCamera() {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  }

  function clearPreview() {
    $('preview').innerHTML = 'üì∑ Elige o toma una foto';
  }

  function renderPreview() {
    const items = [...selectedFiles];
    if (capturedBlob) items.unshift(capturedBlob);

    if (items.length === 0) { clearPreview(); return; }

    const container = document.createElement('div');
    container.style.display = 'grid';
    container.style.gridTemplateColumns = 'repeat(3, 1fr)';
    container.style.gap = '6px';

    items.slice(0, 9).forEach((fileOrBlob) => {
      const url = URL.createObjectURL(fileOrBlob);
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'vista previa';
      img.style.width = '100%';
      img.style.height = '80px';
      img.style.objectFit = 'cover';
      img.onload = () => URL.revokeObjectURL(url);
      container.appendChild(img);
    });

    $('preview').innerHTML = '';
    $('preview').appendChild(container);
  }

  function resetForm() {
    stopCamera();
    selectedFiles = [];
    capturedBlob = null;
    $('file').value = '';
    $('cameraFile').value = '';
    code.value = '';
    locationSel.selectedIndex = 0;
    jobsite.value = '';
    clearPreview();
    $('captureBtn').textContent = 'üì∏ Usar c√°mara';
    submitBtn.textContent = 'Enviar';
    submitBtn.disabled = true;
  }

  async function loadLocations(){
    try{
      const r = await fetch('/api/locations?ts=' + Date.now(), { cache: 'no-store' });
      const j = await r.json();
      const names = (j.locations || []).slice().sort(
        (a,b)=> a.localeCompare(b,'es',{sensitivity:'base'})
      );
      names.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = String(name).toUpperCase();
        locationSel.appendChild(opt);
      });
    }catch(e){
      console.error(e);
      showMsg('No se pudieron cargar las ubicaciones', false);
    }
  }

  // ---------- Events ----------
  jobsite.addEventListener('input', () => { jobsite.value = jobsite.value.toUpperCase(); enableSubmit(); });

  $('chooseBtn').onclick = () => $('file').click();

  $('file').onchange = (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    const tooBig = files.find(f => f.size > 5 * 1024 * 1024);
    if (tooBig) { showMsg('Cada imagen debe ser ‚â§ 5 MB', false); return; }

    const notImage = files.find(f => !/^image\//.test(f.type));
    if (notImage) { showMsg('Selecciona solo archivos de imagen', false); return; }

    selectedFiles.push(...files);
    if (selectedFiles.length > 10) selectedFiles = selectedFiles.slice(0, 10);

    renderPreview();
    enableSubmit();
    e.target.value = '';
  };

  $('captureBtn').onclick = async () => {
    if (isMobile) { $('cameraFile').click(); return; }
    try {
      if (!stream) {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video = document.createElement('video');
        video.autoplay = true;
        video.srcObject = stream;
        $('preview').innerHTML = '';
        $('preview').appendChild(video);
        $('captureBtn').textContent = 'üì∏ Capturar';
      } else {
        const c = document.createElement('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        capturedBlob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.85));
        stopCamera();
        $('captureBtn').textContent = 'üì∏ Usar c√°mara';
        renderPreview();
        enableSubmit();
      }
    } catch (e) { console.error(e); showMsg('C√°mara no disponible', false); }
  };

  $('cameraFile').addEventListener('change', (e) => {
    const f = e.target.files[0]; if (!f) return;
    if (!/^image\//.test(f.type)) { showMsg('Toma una imagen', false); return; }
    if (f.size > 5 * 1024 * 1024) { showMsg('M√°x 5 MB', false); return; }
    capturedBlob = f;
    renderPreview();
    enableSubmit();
    e.target.value = '';
  });

  code.addEventListener('input', enableSubmit);
  locationSel.addEventListener('change', enableSubmit);

  submitBtn.onclick = async () => {
    const btn = submitBtn;
    btn.disabled = true; btn.textContent = 'Subiendo‚Ä¶';
    try {
      const fd = new FormData();
      fd.append('code',     code.value.trim());
      fd.append('location', locationSel.value);
      fd.append('jobsite',  jobsite.value.trim());

      selectedFiles.forEach((f, i) => fd.append('photos', f, f.name || `foto-${i+1}.jpg`));
      if (capturedBlob) fd.append('photos', capturedBlob, 'camara.jpg');

      const r = await fetch('/api/submit', { method: 'POST', body: fd });
      const j = await r.json();
      if (!r.ok) throw new Error(j.error || 'Fallo al subir');

      const total = j.count ?? (selectedFiles.length + (capturedBlob?1:0));
      showMsg(`‚úÖ Se subieron ${total} foto(s)`, true);
    } catch (e) {
      console.error(e); showMsg('‚ùå ' + e.message, false);
    } finally {
      resetForm();
    }
  };

  // ---------- Init ----------
  loadLocations();
  enableSubmit();
</script>

</body>
<div class="lang-toggle" role="navigation" aria-label="Idioma">
  <a href="/upload.html" hreflang="en">EN</a>
</div>

</html>
