<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CQS | Subir Parte de Horas</title>
  <style>
    /* ===============================
       Theme tokens
    =================================*/
    :root {
      --bg-start: #0a0a0a;
      --bg-end:   #1a1a1a;

      --text:  #ffffff;
      --muted: #9aa0a6;
      --hint:  #cfd3d7;

      --accent:   #00ff88;
      --accent-2: #00cc6a;

      --glass:   rgba(255,255,255,.08);
      --glass-br:rgba(255,255,255,.15);
      --glass-hr:rgba(255,255,255,.20);
    }

    /* ===============================
       Reset / Base
    =================================*/
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
    }

    /* ===============================
       Layout / Typography
    =================================*/
    .container {
      width: 100%;
      max-width: 440px;
      margin: auto;
      padding: 24px;
    }

    .logo {
      margin-bottom: 6px;
      text-align: center;
      font-size: 28px;
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0,255,136,.3);
    }

    .subtitle {
      margin-bottom: 24px;
      text-align: center;
      font-size: 14px;
      color: var(--muted);
    }

    .card {
      margin-bottom: 16px;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid var(--glass-br);
      background: var(--glass);
      backdrop-filter: blur(10px);
    }

    /* ===============================
       Form elements
    =================================*/
    label {
      display: block;
      margin: 10px 0 8px;
      font-size: 14px;
      color: var(--hint);
    }

    input,
    select {
      width: 100%;
      margin-bottom: 14px;
      padding: 14px;
      border: 1px solid var(--glass-hr);
      border-radius: 10px;
      background: rgba(255,255,255,.1);
      color: var(--text);
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(0,255,136,.2);
    }

    /* nicer native select caret */
    select {
      appearance: none;
      padding-right: 2.6em;
      background-image:
        linear-gradient(45deg, transparent 50%, #bbb 50%),
        linear-gradient(135deg, #bbb 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 20px) calc(50% - 4px),
        calc(100% - 14px) calc(50% - 4px),
        calc(100% - 2.2em) .6em;
      background-size: 6px 6px, 6px 6px, 1px 1.4em;
      background-repeat: no-repeat;
    }

    select option {
      background-color: #0f0f0f;
      color: #fff;
    }

    /* ===============================
       Camera / Preview
    =================================*/
    .camera {
      margin-top: 8px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(255,255,255,.05);
    }

    .preview {
      height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }

    .preview img,
    .preview video {
      width: 100%;
      height: 260px;
      display: block;
      object-fit: cover;
    }

    .camera-actions {
      display: grid;
      gap: 8px;
      padding: 12px;
      text-align: center;
    }

    /* ===============================
       Buttons
    =================================*/
    .btn {
      width: 100%;
      padding: 16px;
      border: 0;
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: .5px;
      cursor: pointer;
      transition: transform .15s, box-shadow .15s, opacity .15s;
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }

    .btn-primary {
      margin-top: 12px;
      color: #000;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 24px rgba(0,255,136,.3);
    }

    .btn-primary:not(:disabled):hover { transform: translateY(-1px); }

    .btn-sec {
      color: #fff;
      background: linear-gradient(135deg, #4a9eff, #0066cc);
    }

    .btn-sec:hover { transform: translateY(-1px); }

    /* ===============================
       Messages & Nav
    =================================*/
    .msg {
      display: none;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      text-align: center;
    }

    .msg.ok {
      display: block;
      color: #000;
      background: linear-gradient(135deg, #00ff88, #00cc6a);
    }

    .msg.err {
      display: block;
      color: #fff;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    }

    .nav-links{margin-top:10px;text-align:center}
        .btn-link{
            display:inline-block;padding:12px 16px;border-radius:10px;
            border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);
            color:#cfd3d7;text-decoration:none;font-weight:700;letter-spacing:.3px
        }
        .btn-link:hover{border-color:#00ff88;box-shadow:0 0 8px rgba(0,255,136,.2);color:#fff}

    .nav a:hover { transform: translateY(-1px); }

    /* ===============================
       Tiny language toggle
    =================================*/
    .lang-toggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 50;
    }

    .lang-toggle a {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      color: #cfd3d7;
      text-decoration: none;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      transition: transform .15s;
    }

    .lang-toggle a:hover { transform: translateY(-1px); }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">CQS Subida</div>
    <div class="subtitle">Env√≠a hasta 5 fotos por d√≠a por ubicaci√≥n</div>

    <div id="message" class="msg" role="status" aria-live="polite"></div>

    <div class="card">
      <label for="code">C√≥digo de acceso</label>
      <input id="code" type="password" placeholder="Ingresa el c√≥digo" autocomplete="one-time-code" required />

      <label for="location">Ubicaci√≥n</label>
      <select id="location" required>
        <option value="">Selecciona una ubicaci√≥n‚Ä¶</option>
      </select>

      <div class="camera" style="margin-top:8px">
        <div id="preview" class="preview">üì∑ Elige o toma una foto</div>
        <div class="camera-actions">
          <input id="file" type="file" accept="image/*" hidden />
          <input id="cameraFile" type="file" accept="image/*" capture="environment" hidden />
          <button id="chooseBtn"  class="btn btn-sec" type="button">üìÅ Elegir foto</button>
          <button id="captureBtn" class="btn btn-sec" type="button">üì∏ Usar c√°mara</button>
        </div>
      </div>

      <button id="submitBtn" class="btn btn-primary" style="margin-top:12px" disabled>Enviar</button>

    
    </div>
    <div class="nav-links" style="margin-top:12px">
        <a class = "btn-link" href = "/index-es.html">‚Üê Volver al Inicio</a>
      </div>
  </div>

  <script>
    let photoBlob=null, stream=null, video=null, msgHideTimer=null;
    const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const el=id=>document.getElementById(id);

    function showMsg(text, ok=true){
      const m=el('message'); m.style.display='block';
      m.className='msg '+(ok?'ok':'err'); m.textContent=text;
      if(msgHideTimer) clearTimeout(msgHideTimer);
      msgHideTimer=setTimeout(()=>{ m.style.display='none'; }, 5000);
    }

    function enableSubmit(){
      el('submitBtn').disabled = !( el('code').value.trim() && el('location').value && photoBlob );
    }

    function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }

    function resetForm(){
      stopCamera(); photoBlob=null;
      el('file').value=''; el('cameraFile').value='';
      el('code').value=''; el('location').selectedIndex=0;
      el('preview').textContent='üì∑ Elige o toma una foto';
      el('captureBtn').textContent='üì∏ Usar c√°mara';
      el('submitBtn').textContent='Enviar'; el('submitBtn').disabled=true;
    }

    async function loadLocations(){
    try{
      // cache-bust so you always get the freshest list
      const r = await fetch('/api/locations?ts=' + Date.now(), { cache: 'no-store' });
      const j = await r.json();
      const sel = el('location');

      const names = (j.locations || [])
        .slice()
        .sort((a,b)=> a.localeCompare(b,'en',{sensitivity:'base'}));

      names.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;                 // keep original value
        opt.textContent = String(name).toUpperCase(); // show ALL CAPS
        sel.appendChild(opt);
      });
    }catch(e){ console.error(e); }
  }

    el('chooseBtn').onclick=()=>el('file').click();
    el('file').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      if(!/^image\//.test(f.type)) { showMsg('Selecciona una imagen', false); return; }
      if(f.size>5*1024*1024) { showMsg('M√°ximo 5MB', false); return; }
      photoBlob=f;
      const r=new FileReader();
      r.onload=()=>{ el('preview').innerHTML=`<img src="${r.result}" alt="vista previa">`; enableSubmit(); };
      r.readAsDataURL(f); e.target.value='';
    };

    el('captureBtn').onclick=async()=>{
      if(isMobile){ el('cameraFile').click(); return; }
      try{
        if(!stream){
          stream=await navigator.mediaDevices.getUserMedia({video:true});
          video=document.createElement('video'); video.autoplay=true; video.srcObject=stream;
          el('preview').innerHTML=''; el('preview').appendChild(video);
          el('captureBtn').textContent='üì∏ Capturar';
        }else{
          const c=document.createElement('canvas');
          c.width=video.videoWidth; c.height=video.videoHeight;
          c.getContext('2d').drawImage(video,0,0);
          photoBlob=await new Promise(res=>c.toBlob(res,'image/jpeg',0.85));
          stopCamera(); el('preview').innerHTML=`<img src="${c.toDataURL()}" alt="capturada">`;
          el('captureBtn').textContent='üì∏ Usar c√°mara'; enableSubmit();
        }
      }catch(e){ console.error(e); showMsg('C√°mara no disponible', false); }
    };

    el('cameraFile').addEventListener('change', e=>{
      const f=e.target.files[0]; if(!f) return;
      if(!/^image\//.test(f.type)) { showMsg('Captura una imagen', false); return; }
      if(f.size>5*1024*1024) { showMsg('M√°ximo 5MB', false); return; }
      photoBlob=f; const r=new FileReader();
      r.onload=()=>{ el('preview').innerHTML=`<img src="${r.result}" alt="vista previa">`; enableSubmit(); };
      r.readAsDataURL(f); e.target.value='';
    });

    el('code').oninput=enableSubmit; el('location').onchange=enableSubmit;

    el('submitBtn').onclick=async()=>{
      const btn=el('submitBtn'); btn.disabled=true; btn.textContent='Subiendo‚Ä¶';
      try{
        const fd=new FormData();
        fd.append('code', el('code').value.trim());
        fd.append('location', el('location').value);
        fd.append('photo', photoBlob, 'photo.jpg');

        const r=await fetch('/api/submit',{method:'POST',body:fd});
        const j=await r.json(); if(!r.ok) throw new Error(j.error||'Fallo al enviar');
        showMsg('‚úÖ Subida exitosa', true);
      }catch(e){ console.error(e); showMsg('‚ùå '+e.message, false); }
      finally{ resetForm(); }
    };

    loadLocations(); enableSubmit();
  </script>
</body>
<div class="lang-toggle" role="navigation" aria-label="Idioma">
  <a href="/Upload.html" hreflang="en">EN</a>
</div>


</html>
